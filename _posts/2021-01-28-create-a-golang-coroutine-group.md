---
layout: post
title:  "Create A Golang Coroutine Group 手撸Golang协程并发器"
author: devfans
categories: [ errgroup, golang, coroutine ]
image: /static.livefeed.cn/static/blog/mq-app.png
tags: [sticky]
---

业务中经常要处理一批任务需要多线程处理，这时如何有效的控制任务执行细节和线程并发就变的很重要。因为大家都造了很多轮子，来，我也造一个！

### 并发控制器主要思考点

#### 任务是否需要有序执行
一般任务可以并列执行，如果需要部分有序执行，那只能分成多个执行队列。如果需要全部有序，那估计没得玩了，逐个干吧。

#### 控制并发量
机器资源有限，如果不控制并发量任意开新的执行线程，反而会使任务执行效率变低。

#### 任务执行结果反馈
如果任务执行结果需要收集，可以考虑用channel或着写数据库。如果执行结果出错，则判断是否需要反馈给线程池。一般任务的执行结果可以直接丢掉，如果执行出错，可能也会直接略过，或着回Queue等待下次执行。同时可以加error recover防止影响程序继续执行。

#### 任务取消控制
如果上游Context触发取消，那么线程池中的任务就需要有序取消，特别是任务中的非事务性数据操作。

#### 任务完成等待
做任务计数，如果没有发生中途取消，则等待全部完成。


### 
